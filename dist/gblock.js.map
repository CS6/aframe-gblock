{"version":3,"file":"gblock.js","sources":["../src/gblock.js"],"sourcesContent":["import fsBase64 from './fragment-shader.glsl'\nimport vsBase64 from './vector-shader.glsl'\n\nfunction GBlockLoader () {\n\n  THREE.GLTFLoader.call(this)\n\n  var self = this\n\n  this._parse = this.parse\n  this.parse = function (data, path, onLoad, onError) {\n    // convert uint8 to json\n    var json = JSON.parse(convertUint8ArrayToString(data))\n    // use base64 shaders\n    Object.keys(json.shaders).forEach(function (key, i) {\n      if (key.indexOf('fragment') > -1) json.shaders[key].uri = fsBase64\n      else if (key.indexOf('vertex') > -1) json.shaders[key].uri = vsBase64\n    })\n    // convert json to uint8\n    var uint8array = new TextEncoder('utf-8').encode(JSON.stringify(json))\n    // parse data\n    self._parse.call(self, uint8array, path, onLoad, onError)\n  }\n\n}\nGBlockLoader.prototype = THREE.GLTFLoader.prototype\n\n// aframe module\n\nAFRAME.registerComponent('gblock', {\n  schema: {type: 'asset'},\n\n  init: function () {\n    this.model = null;\n    this.loader = new GBlockLoader();\n  },\n\n  update: function () {\n    var self = this;\n    var el = this.el;\n    var src = this.data;\n\n    if (!src) { return; }\n\n    this.remove();\n\n    var id = src.split('/').pop()\n\n    fetch('https://gblock.herokuapp.com/get-gltf-url/' + id).then(function (response) {\n      return response.text().then(function (body) {\n        if (!response.ok) throw new Error('ERROR: ' + response.status + ' \"' + body + '\"')\n\n        self.loader.load(body, function gltfLoaded (gltfModel) {\n          self.model = gltfModel.scene || gltfModel.scenes[0];\n          // FIXME: use original blocks shaders?\n          self.model.traverse(function (child) {\n            if (child.material) child.material = new THREE.MeshPhongMaterial({ vertexColors: THREE.VertexColors })\n          })\n          self.model.animations = gltfModel.animations;\n          el.setObject3D('mesh', self.model);\n          el.emit('model-loaded', {format: 'gltf', model: self.model});\n        });\n\n      })\n    })\n\n  },\n\n  remove: function () {\n    if (!this.model) { return; }\n    this.el.removeObject3D('mesh');\n  }\n});\n\n// helpers\n\n// from https://github.com/mrdoob/three.js/blob/master/examples/js/loaders/GLTFLoader.js\nfunction convertUint8ArrayToString (array) {\n  if (window.TextDecoder !== undefined) {\n    return new TextDecoder().decode(array);\n  }\n  // Avoid the String.fromCharCode.apply(null, array) shortcut, which\n  // throws a \"maximum call stack size exceeded\" error for large arrays.\n  var s = '';\n  for (var i = 0, il = array.length; i < il; i++) {\n    s += String.fromCharCode(array[i]);\n  }\n  return s;\n}\n"],"names":[],"mappings":"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"}