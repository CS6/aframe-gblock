{"version":3,"file":"gblock.js","sources":["../src/gblock.js"],"sourcesContent":["import fsBase64 from './fragment-shader.glsl'\nimport vsBase64 from './vector-shader.glsl'\n\n\nfunction GBlockLoader () {\n\n\tTHREE.GLTFLoader.call(this)\n\n\tvar self = this\n\n\tthis._parse = this.parse\n\tthis.parse = function (data, path, onLoad, onError) {\n\t\t// convert uint8 to json\n\t\tvar json = JSON.parse(convertUint8ArrayToString(data))\n\t\t// use base64 shaders\n\t\tObject.keys(json.shaders).forEach(function(key, i){\n\t\t\tif (json.shaders[key].uri.indexOf('fs.glsl') > -1) json.shaders[key].uri = fsBase64\n\t\t\telse if (json.shaders[key].uri.indexOf('vs.glsl') > -1) json.shaders[key].uri = vsBase64\n\t\t})\n\t\t// convert json to uint8\n\t\tvar uint8array = new TextEncoder('utf-8').encode(JSON.stringify(json))\n\t\t// parse data\n\t\tself._parse.call(self, uint8array, path, onLoad, onError)\n\t}\n\n}\nGBlockLoader.prototype = THREE.GLTFLoader.prototype\n\n// aframe module\n\nAFRAME.registerComponent('gblock', {\n\tschema: {type: 'asset'},\n\n\tinit: function () {\n\t\tthis.model = null;\n\t\tthis.loader = new GBlockLoader();\n\t},\n\n\tupdate: function () {\n\t\tvar self = this;\n\t\tvar el = this.el;\n\t\tvar src = this.data;\n\n\t\tif (!src) { return; }\n\n\t\tthis.remove();\n\n\t\tvar id = src.split('/').pop()\n\n\t\tfetch('https://gblock.herokuapp.com/get-gltf-url/'+id).then(function(response){\n\t\t\treturn response.text().then(function(body){\n\t\t\t\tif (!response.ok) throw new Error('ERROR: '+response.status+' \"'+body+'\"')\n\n\t\t\t\tself.loader.load( body, function gltfLoaded (gltfModel) {\n\t\t\t\t\tself.model = gltfModel.scene || gltfModel.scenes[0];\n\t\t\t\t\tself.model.traverse(function(child){\n\t\t\t\t\t\tif (child.material) child.material = new THREE.MeshPhongMaterial()\n\t\t\t\t\t})\n\t\t\t\t\tself.model.animations = gltfModel.animations;\n\t\t\t\t\tel.setObject3D('mesh', self.model);\n\t\t\t\t\tel.emit('model-loaded', {format: 'gltf', model: self.model});\n\t\t\t\t});\n\n\t\t\t})\n\t\t})\n\n\t},\n\n\tremove: function () {\n\t\tif (!this.model) { return; }\n\t\tthis.el.removeObject3D('mesh');\n\t}\n});\n\n// helpers\n\n// from https://github.com/mrdoob/three.js/blob/master/examples/js/loaders/GLTFLoader.js\nfunction convertUint8ArrayToString( array ) {\n\tif ( window.TextDecoder !== undefined ) {\n\t\treturn new TextDecoder().decode( array );\n\t}\n\t// Avoid the String.fromCharCode.apply(null, array) shortcut, which\n\t// throws a \"maximum call stack size exceeded\" error for large arrays.\n\tvar s = '';\n\tfor ( var i = 0, il = array.length; i < il; i ++ ) {\n\t\ts += String.fromCharCode( array[ i ] );\n\t}\n\treturn s;\n}\n"],"names":[],"mappings":"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"}