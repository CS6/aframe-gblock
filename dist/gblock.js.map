{"version":3,"file":"gblock.js","sources":["../src/gblock.js"],"sourcesContent":["import fsBase64 from './fragment-shader.glsl'\r\nimport vsBase64 from './vector-shader.glsl'\r\n\r\nfunction GBlockLoader () {\r\n\r\n  THREE.GLTFLoader.call(this)\r\n\r\n  var self = this\r\n\r\n  this._parse = this.parse\r\n  this.parse = function (data, path, onLoad, onError) {\r\n    // convert uint8 to json\r\n    var json = JSON.parse(convertUint8ArrayToString(data))\r\n    // use base64 shaders\r\n    Object.keys(json.shaders).forEach(function (key, i) {\r\n      if (key.indexOf('fragment') > -1) json.shaders[key].uri = fsBase64\r\n      else if (key.indexOf('vertex') > -1) json.shaders[key].uri = vsBase64\r\n    })\r\n    // convert json to uint8\r\n    var uint8array = new TextEncoder('utf-8').encode(JSON.stringify(json))\r\n    // parse data\r\n    self._parse.call(self, uint8array, path, onLoad, onError)\r\n  }\r\n\r\n}\r\nGBlockLoader.prototype = THREE.GLTFLoader.prototype\r\n\r\n// aframe module\r\n\r\nAFRAME.registerComponent('gblock', {\r\n  schema: {type: 'asset'},\r\n\r\n  init: function () {\r\n    this.model = null;\r\n    this.loader = new GBlockLoader();\r\n  },\r\n\r\n  update: function () {\r\n    var self = this;\r\n    var el = this.el;\r\n    var src = this.data;\r\n\r\n    if (!src) { return; }\r\n\r\n    this.remove();\r\n\r\n    // FIXME: Replace this with an official API URL once available\r\n    // This API call is only needed to obtain the official glTF URL of a google block model.\r\n    // The glTF itself is not being proxied and gets fetched from https://vr.google.com/downloads/* directly.\r\n    // https://github.com/archilogic-com/aframe-gblock/issues/1\r\n    // API server code: server/index.js\r\n    fetch('https://us-central1-gblock-api.cloudfunctions.net/get-gltf-url/?url=' + src).then(function (response) {\r\n\r\n      return response.json().then(function (message) {\r\n        if (!response.ok) throw new Error('ERROR: ' + response.status + ' \"' + message.message + '\"')\r\n\r\n        // load glTF model from original URL\r\n        var gltfUrl = message.gltfUrl\r\n\r\n        self.loader.load( gltfUrl, function gltfLoaded (gltfModel) {\r\n          self.model = gltfModel.scene || gltfModel.scenes[0];\r\n          // FIXME: adapt projection matrix in original shaders\r\n          self.model.traverse(function (child) {\r\n            if (child.material) child.material = new THREE.MeshPhongMaterial({ vertexColors: THREE.VertexColors })\r\n          })\r\n          self.model.animations = gltfModel.animations;\r\n          el.setObject3D('mesh', self.model);\r\n          el.emit('model-loaded', {format: 'gltf', model: self.model});\r\n        });\r\n\r\n      })\r\n    })\r\n\r\n  },\r\n\r\n  remove: function () {\r\n    if (!this.model) { return; }\r\n    this.el.removeObject3D('mesh');\r\n  }\r\n});\r\n\r\n// helpers\r\n\r\n// from https://github.com/mrdoob/three.js/blob/master/examples/js/loaders/GLTFLoader.js\r\nfunction convertUint8ArrayToString (array) {\r\n  if (window.TextDecoder !== undefined) {\r\n    return new TextDecoder().decode(array);\r\n  }\r\n  // Avoid the String.fromCharCode.apply(null, array) shortcut, which\r\n  // throws a \"maximum call stack size exceeded\" error for large arrays.\r\n  var s = '';\r\n  for (var i = 0, il = array.length; i < il; i++) {\r\n    s += String.fromCharCode(array[i]);\r\n  }\r\n  return s;\r\n}\r\n"],"names":[],"mappings":"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"}