// https://github.com/archilogic-com/aframe-gblock
(function () {
	'use strict';

	var fsBase64 = "data:text/plain;base64,cHJlY2lzaW9uIGhpZ2hwIGZsb2F0Ow0KDQpjb25zdCBmbG9hdCBJTlZfUEkgPSAwLjMxODMwOTg4NjE4Ow0KY29uc3QgZmxvYXQgUEkgPSAzLjE0MTU5MjY1NDsNCmNvbnN0IGZsb2F0IF9SZWZyYWN0aXZlSW5kZXggPSAxLjI7DQpjb25zdCBmbG9hdCBlbnZpcm9ubWVudFN0cmVuZ3RoID0gMS41Ow0KDQp2YXJ5aW5nIHZlYzMgdl9ub3JtYWw7DQp2YXJ5aW5nIHZlYzMgdl9wb3NpdGlvbjsNCnZhcnlpbmcgdmVjMyB2X2Jpbm9ybWFsOw0KdmFyeWluZyB2ZWMzIHZfdGFuZ2VudDsNCg0KdW5pZm9ybSB2ZWMzIHVfY29sb3I7DQp1bmlmb3JtIGZsb2F0IHVfbWV0YWxsaWM7DQp1bmlmb3JtIGZsb2F0IHVfcm91Z2huZXNzOw0KdW5pZm9ybSB2ZWMzIHVfbGlnaHQwUG9zOw0KdW5pZm9ybSB2ZWMzIHVfbGlnaHQwQ29sb3I7DQp1bmlmb3JtIHZlYzMgdV9saWdodDFQb3M7DQp1bmlmb3JtIHZlYzMgdV9saWdodDFDb2xvcjsNCnVuaWZvcm0gbWF0NCB1X21vZGVsTWF0cml4Ow0KdW5pZm9ybSBzYW1wbGVyMkQgdV9yZWZsZWN0aW9uQ3ViZTsNCnVuaWZvcm0gc2FtcGxlcjJEIHVfcmVmbGVjdGlvbkN1YmVCbHVyOw0KDQpjb25zdCBmbG9hdCB1X25vaXNlSW50ZW5zaXR5ID0gMC4wMTU7DQpjb25zdCBmbG9hdCBjb2xvck5vaXNlQW1vdW50ID0gMC4wMTU7DQpjb25zdCBmbG9hdCBub2lzZVNjYWxlID0gNzAwLjA7DQoNCnVuaWZvcm0gdmVjMyBjYW1lcmFQb3NpdGlvbjsNCg0KLy8gTm9pc2UgZnVuY3Rpb25zIGZyb20gaHR0cHM6Ly9naXRodWIuY29tL2FzaGltYS93ZWJnbC1ub2lzZQ0KLy8gVXNlZCB1bmRlciB0aGUgTUlUIGxpY2Vuc2UgLSBsaWNlbnNlIHRleHQgaW4gTUlUTElDRU5TRQ0KLy8gQ29weXJpZ2h0IChDKSAyMDExIGJ5IEFzaGltYSBBcnRzIChTaW1wbGV4IG5vaXNlKQ0KLy8gQ29weXJpZ2h0IChDKSAyMDExLTIwMTYgYnkgU3RlZmFuIEd1c3RhdnNvbiAoQ2xhc3NpYyBub2lzZSBhbmQgb3RoZXJzKQ0KdmVjMyBtb2QyODkodmVjMyB4KSB7DQogIHJldHVybiB4IC0gZmxvb3IoeCAqICgxLjAgLyAyODkuMCkpICogMjg5LjA7DQp9DQoNCnZlYzQgbW9kMjg5KHZlYzQgeCkgew0KICByZXR1cm4geCAtIGZsb29yKHggKiAoMS4wIC8gMjg5LjApKSAqIDI4OS4wOw0KfQ0KDQp2ZWM0IHBlcm11dGUodmVjNCB4KSB7DQogICAgIHJldHVybiBtb2QyODkoKCh4KjM0LjApKzEuMCkqeCk7DQp9DQoNCnZlYzQgdGF5bG9ySW52U3FydCh2ZWM0IHIpDQp7DQogIHJldHVybiAxLjc5Mjg0MjkxNDAwMTU5IC0gMC44NTM3MzQ3MjA5NTMxNCAqIHI7DQp9DQoNCmZsb2F0IHNub2lzZSh2ZWMzIHYsIG91dCB2ZWMzIGdyYWRpZW50KQ0Kew0KICBjb25zdCB2ZWMyICBDID0gdmVjMigxLjAvNi4wLCAxLjAvMy4wKSA7DQogIGNvbnN0IHZlYzQgIEQgPSB2ZWM0KDAuMCwgMC41LCAxLjAsIDIuMCk7DQoNCi8vIEZpcnN0IGNvcm5lcg0KICB2ZWMzIGkgID0gZmxvb3IodiArIGRvdCh2LCBDLnl5eSkgKTsNCiAgdmVjMyB4MCA9ICAgdiAtIGkgKyBkb3QoaSwgQy54eHgpIDsNCg0KLy8gT3RoZXIgY29ybmVycw0KICB2ZWMzIGcgPSBzdGVwKHgwLnl6eCwgeDAueHl6KTsNCiAgdmVjMyBsID0gMS4wIC0gZzsNCiAgdmVjMyBpMSA9IG1pbiggZy54eXosIGwuenh5ICk7DQogIHZlYzMgaTIgPSBtYXgoIGcueHl6LCBsLnp4eSApOw0KDQogIC8vICAgeDAgPSB4MCAtIDAuMCArIDAuMCAqIEMueHh4Ow0KICAvLyAgIHgxID0geDAgLSBpMSAgKyAxLjAgKiBDLnh4eDsNCiAgLy8gICB4MiA9IHgwIC0gaTIgICsgMi4wICogQy54eHg7DQogIC8vICAgeDMgPSB4MCAtIDEuMCArIDMuMCAqIEMueHh4Ow0KICB2ZWMzIHgxID0geDAgLSBpMSArIEMueHh4Ow0KICB2ZWMzIHgyID0geDAgLSBpMiArIEMueXl5OyAvLyAyLjAqQy54ID0gMS8zID0gQy55DQogIHZlYzMgeDMgPSB4MCAtIEQueXl5OyAgICAgIC8vIC0xLjArMy4wKkMueCA9IC0wLjUgPSAtRC55DQoNCi8vIFBlcm11dGF0aW9ucw0KICBpID0gbW9kMjg5KGkpOw0KICB2ZWM0IHAgPSBwZXJtdXRlKCBwZXJtdXRlKCBwZXJtdXRlKA0KICAgICAgICAgICAgIGkueiArIHZlYzQoMC4wLCBpMS56LCBpMi56LCAxLjAgKSkNCiAgICAgICAgICAgKyBpLnkgKyB2ZWM0KDAuMCwgaTEueSwgaTIueSwgMS4wICkpDQogICAgICAgICAgICsgaS54ICsgdmVjNCgwLjAsIGkxLngsIGkyLngsIDEuMCApKTsNCg0KLy8gR3JhZGllbnRzOiA3eDcgcG9pbnRzIG92ZXIgYSBzcXVhcmUsIG1hcHBlZCBvbnRvIGFuIG9jdGFoZWRyb24uDQovLyBUaGUgcmluZyBzaXplIDE3KjE3ID0gMjg5IGlzIGNsb3NlIHRvIGEgbXVsdGlwbGUgb2YgNDkgKDQ5KjYgPSAyOTQpDQogIGZsb2F0IG5fID0gMC4xNDI4NTcxNDI4NTc7IC8vIDEuMC83LjANCiAgdmVjMyAgbnMgPSBuXyAqIEQud3l6IC0gRC54eng7DQoNCiAgdmVjNCBqID0gcCAtIDQ5LjAgKiBmbG9vcihwICogbnMueiAqIG5zLnopOyAgLy8gIG1vZChwLDcqNykNCg0KICB2ZWM0IHhfID0gZmxvb3IoaiAqIG5zLnopOw0KICB2ZWM0IHlfID0gZmxvb3IoaiAtIDcuMCAqIHhfICk7ICAgIC8vIG1vZChqLE4pDQoNCiAgdmVjNCB4ID0geF8gKm5zLnggKyBucy55eXl5Ow0KICB2ZWM0IHkgPSB5XyAqbnMueCArIG5zLnl5eXk7DQogIHZlYzQgaCA9IDEuMCAtIGFicyh4KSAtIGFicyh5KTsNCg0KICB2ZWM0IGIwID0gdmVjNCggeC54eSwgeS54eSApOw0KICB2ZWM0IGIxID0gdmVjNCggeC56dywgeS56dyApOw0KDQogIC8vdmVjNCBzMCA9IHZlYzQobGVzc1RoYW4oYjAsMC4wKSkqMi4wIC0gMS4wOw0KICAvL3ZlYzQgczEgPSB2ZWM0KGxlc3NUaGFuKGIxLDAuMCkpKjIuMCAtIDEuMDsNCiAgdmVjNCBzMCA9IGZsb29yKGIwKSoyLjAgKyAxLjA7DQogIHZlYzQgczEgPSBmbG9vcihiMSkqMi4wICsgMS4wOw0KICB2ZWM0IHNoID0gLXN0ZXAoaCwgdmVjNCgwLjApKTsNCg0KICB2ZWM0IGEwID0gYjAueHp5dyArIHMwLnh6eXcqc2gueHh5eSA7DQogIHZlYzQgYTEgPSBiMS54enl3ICsgczEueHp5dypzaC56end3IDsNCg0KICB2ZWMzIHAwID0gdmVjMyhhMC54eSxoLngpOw0KICB2ZWMzIHAxID0gdmVjMyhhMC56dyxoLnkpOw0KICB2ZWMzIHAyID0gdmVjMyhhMS54eSxoLnopOw0KICB2ZWMzIHAzID0gdmVjMyhhMS56dyxoLncpOw0KDQovL05vcm1hbGlzZSBncmFkaWVudHMNCiAgdmVjNCBub3JtID0gdGF5bG9ySW52U3FydCh2ZWM0KGRvdChwMCxwMCksIGRvdChwMSxwMSksIGRvdChwMiwgcDIpLCBkb3QocDMscDMpKSk7DQogIHAwICo9IG5vcm0ueDsNCiAgcDEgKj0gbm9ybS55Ow0KICBwMiAqPSBub3JtLno7DQogIHAzICo9IG5vcm0udzsNCg0KLy8gTWl4IGZpbmFsIG5vaXNlIHZhbHVlDQogIHZlYzQgbSA9IG1heCgwLjYgLSB2ZWM0KGRvdCh4MCx4MCksIGRvdCh4MSx4MSksIGRvdCh4Mix4MiksIGRvdCh4Myx4MykpLCAwLjApOw0KICB2ZWM0IG0yID0gbSAqIG07DQogIHZlYzQgbTQgPSBtMiAqIG0yOw0KICB2ZWM0IHBkb3R4ID0gdmVjNChkb3QocDAseDApLCBkb3QocDEseDEpLCBkb3QocDIseDIpLCBkb3QocDMseDMpKTsNCg0KLy8gRGV0ZXJtaW5lIG5vaXNlIGdyYWRpZW50DQogIHZlYzQgdGVtcCA9IG0yICogbSAqIHBkb3R4Ow0KICBncmFkaWVudCA9IC04LjAgKiAodGVtcC54ICogeDAgKyB0ZW1wLnkgKiB4MSArIHRlbXAueiAqIHgyICsgdGVtcC53ICogeDMpOw0KICBncmFkaWVudCArPSBtNC54ICogcDAgKyBtNC55ICogcDEgKyBtNC56ICogcDIgKyBtNC53ICogcDM7DQogIGdyYWRpZW50ICo9IDQyLjA7DQoNCiAgcmV0dXJuIDQyLjAgKiBkb3QobTQsIHBkb3R4KTsNCn0NCi8vIEVuZCBvZiBub2lzZSBjb2RlDQoNCmZsb2F0IEdHWChmbG9hdCBuRG90SCwgZmxvYXQgcm91Z2huZXNzMikgew0KICBmbG9hdCBuRG90SDIgPSBuRG90SCAqIG5Eb3RIOw0KICBmbG9hdCBhbHBoYSA9IG5Eb3RIMiAqIHJvdWdobmVzczIgKyAxLjAgLSBuRG90SDI7DQogIGZsb2F0IGRlbm9taW5hdG9yID0gUEkgKiBhbHBoYSAqIGFscGhhOw0KICByZXR1cm4gKG5Eb3RIMiA+IDAuMCA/IDEuMCA6IDAuMCkgKiByb3VnaG5lc3MyIC8gZGVub21pbmF0b3I7DQp9DQoNCmZsb2F0IEJsaW5uUGhvbmdOREYoZmxvYXQgbkRvdEgpIHsNCiAgZmxvYXQgZXhwb25lbnQgPSAoMi4wIC8gKHVfcm91Z2huZXNzICogdV9yb3VnaG5lc3MpIC0gMi4wKTsNCiAgZmxvYXQgY29lZmYgPSAxLjAgLyAoUEkgKiB1X3JvdWdobmVzcyAqIHVfcm91Z2huZXNzKTsNCiAgcmV0dXJuIGNvZWZmICogcG93KG5Eb3RILCBleHBvbmVudCk7DQp9DQoNCmZsb2F0IENUX0dlb0F0dGVuKGZsb2F0IG5Eb3RWLCBmbG9hdCBuRG90SCwgZmxvYXQgdkRvdEgsIGZsb2F0IG5Eb3RMLCBmbG9hdCBsRG90SCkgew0KICBmbG9hdCBhID0gKDIuMCAqIG5Eb3RIICogbkRvdFYpIC8gdkRvdEg7DQogIGZsb2F0IGIgPSAoMi4wICogbkRvdEggKiBuRG90TCkgLyBsRG90SDsNCiAgcmV0dXJuIG1pbigxLjAsIG1pbihhLCBiKSk7DQp9DQoNCmZsb2F0IEdlb0F0dGVuKGZsb2F0IG5Eb3RWKSB7DQogZmxvYXQgYyA9IG5Eb3RWIC8gKHVfcm91Z2huZXNzICogc3FydCgxLjAgLSBuRG90ViAqIG5Eb3RWKSk7DQogcmV0dXJuIGMgPj0gMS42ID8gMS4wIDoNCiAgICAgKDMuNTM1ICogYyArIDIuMTgxICogYyAqIGMpIC8gKDEuMCArIDIuMjc2ICogYyArIDIuNTc3ICogYyAqIGMpOw0KDQp9DQoNCnZlYzMgZXZhbHVhdGVGcmVzbmVsU2NobGljayhmbG9hdCB2RG90SCwgdmVjMyBmMCkgew0KICByZXR1cm4gZjAgKyAoMS4wIC0gZjApICogcG93KDEuMCAtIHZEb3RILCA1LjApOw0KfQ0KDQpmbG9hdCBzYXR1cmF0ZShmbG9hdCB2YWx1ZSkgew0KICByZXR1cm4gY2xhbXAodmFsdWUsIDAuMCwgMS4wKTsNCn0NCg0KdmVjMyBzYXR1cmF0ZSh2ZWMzIHZhbHVlKSB7DQogIHJldHVybiBjbGFtcCh2YWx1ZSwgMC4wLCAxLjApOw0KfQ0KDQoNCm1hdDMgdHJhbnNwb3NlKG1hdDMgaW5NYXQpIHsNCiAgcmV0dXJuIG1hdDMoaW5NYXRbMF1bMF0sIGluTWF0WzBdWzFdLCBpbk1hdFswXVsyXSwNCiAgICAgICAgICAgICAgaW5NYXRbMV1bMF0sIGluTWF0WzFdWzFdLCBpbk1hdFsxXVsyXSwNCiAgICAgICAgICAgICAgaW5NYXRbMl1bMF0sIGluTWF0WzJdWzFdLCBpbk1hdFsyXVsyXSk7DQp9DQoNCnZvaWQgZ2VuZXJhdGVQYXBlcmNyYWZ0Q29sb3JOb3JtYWwodmVjMyBub3JtYWwsIHZlYzMgdGFuZ2VudCwgdmVjMyBiaW5vcm1hbCwgdmVjMyBub2lzZVBvcywgaW5vdXQgdmVjNCBvdXRDb2xvck11bHQsIGlub3V0IHZlYzMgb3V0Tm9ybWFsKSB7DQogIG1hdDMgdGFuZ2VudFRvT2JqZWN0Ow0KICB0YW5nZW50VG9PYmplY3RbMF0gPSB2ZWMzKHRhbmdlbnQueCwgdGFuZ2VudC55LCB0YW5nZW50LnopOw0KICB0YW5nZW50VG9PYmplY3RbMV0gPSB2ZWMzKGJpbm9ybWFsLngsIGJpbm9ybWFsLnksIGJpbm9ybWFsLnopOw0KICB0YW5nZW50VG9PYmplY3RbMl0gPSB2ZWMzKG5vcm1hbC54LCBub3JtYWwueSwgbm9ybWFsLnopOw0KDQogIG1hdDMgb2JqZWN0VG9UYW5nZW50ID0gdHJhbnNwb3NlKHRhbmdlbnRUb09iamVjdCk7DQoNCg0KICB2ZWMzIGludGVuc2lmaWNhdG9yID0gdmVjMyh1X25vaXNlSW50ZW5zaXR5LCB1X25vaXNlSW50ZW5zaXR5LCAxLjApOw0KICB2ZWMzIHRhbmdlbnRQb3MgPSBvYmplY3RUb1RhbmdlbnQgKiBub2lzZVBvczsNCiAgdmVjMyBncmFkaWVudCA9IHZlYzMoMC4wKTsNCiAgZmxvYXQgbm9pc2VPdXQgPSBzbm9pc2UodGFuZ2VudFBvcyAqIG5vaXNlU2NhbGUsIGdyYWRpZW50KTsNCg0KICB2ZWMzIHRhbmdlbnRTcGFjZU5vcm1hbCA9IG5vcm1hbGl6ZShpbnRlbnNpZmljYXRvciAqIHZlYzMoZ3JhZGllbnQueHksIDEuMCkpOw0KICBvdXROb3JtYWwgPSB0YW5nZW50VG9PYmplY3QgKiB0YW5nZW50U3BhY2VOb3JtYWw7DQoNCiAgb3V0Q29sb3JNdWx0ID0gdmVjNCh2ZWMzKDEuMCArIG5vaXNlT3V0ICogY29sb3JOb2lzZUFtb3VudCksIDEuMCk7DQp9DQoNCnZvaWQgZXZhbHVhdGVQQlJMaWdodCgNCiAgdmVjMyBtYXRlcmlhbENvbG9yLA0KICB2ZWMzIGxpZ2h0Q29sb3IsDQogIGZsb2F0IG5Eb3RMLA0KICBmbG9hdCBuRG90ViwNCiAgZmxvYXQgbkRvdEgsDQogIGZsb2F0IHZEb3RILA0KICBmbG9hdCBsRG90SCwNCiAgaW5vdXQgdmVjMyBkaWZmdXNlT3V0LA0KICBpbm91dCB2ZWMzIHNwZWN1bGFyT3V0LA0KICBpbm91dCB2ZWMzIGRlYnVnLA0KICBmbG9hdCBzcGVjQW1vdW50KSB7DQogICAgdmVjMyBkaWZmdXNlID0gSU5WX1BJICogbkRvdEwgKiBsaWdodENvbG9yOw0KDQogICAgdmVjMyBkID0gdmVjMyhHR1gobkRvdEgsIHVfcm91Z2huZXNzICogdV9yb3VnaG5lc3MpKTsNCiAgICB2ZWMzIGcgPSB2ZWMzKENUX0dlb0F0dGVuKG5Eb3RWLCBuRG90SCwgdkRvdEgsIG5Eb3RMLCBsRG90SCkpOw0KICAgIHZlYzMgZjAgPSB2ZWMzKGFicygoMS4wIC0gX1JlZnJhY3RpdmVJbmRleCkgLyAoMS4wICsgX1JlZnJhY3RpdmVJbmRleCkpKTsNCiAgICBmMCA9IGYwICogZjA7DQogICAgZjAgPSBtaXgoZjAsIG1hdGVyaWFsQ29sb3IsIHVfbWV0YWxsaWMpOw0KICAgIHZlYzMgZiA9IGV2YWx1YXRlRnJlc25lbFNjaGxpY2sodkRvdEgsIGYwKTsNCiAgICBkaWZmdXNlT3V0ID0gZGlmZnVzZU91dCArICgxLjAgLSBzYXR1cmF0ZShmKSkgKiAoMS4wIC0gdV9tZXRhbGxpYykgKiBsaWdodENvbG9yICogZGlmZnVzZTsNCiAgICBzcGVjdWxhck91dCA9IHNwZWN1bGFyT3V0ICsgc3BlY0Ftb3VudCAqIGxpZ2h0Q29sb3IgKiBzYXR1cmF0ZSgoZCAqIGcgKiBmKSAvIHNhdHVyYXRlKDQuMCAqIHNhdHVyYXRlKG5Eb3RIKSAqIG5Eb3RWKSk7DQogICAgZGVidWcgPSBzYXR1cmF0ZShnKTsNCn0NCg0Kdm9pZCBzZXRQYXJhbXModmVjMyB3b3JsZFBvc2l0aW9uLA0KICAgIGlub3V0IHZlYzMgbm9ybWFsLA0KICAgIGlub3V0IHZlYzMgdmlldywNCiAgICBpbm91dCBmbG9hdCBuRG90Vikgew0KICBub3JtYWwgPSBub3JtYWxpemUobm9ybWFsKTsNCiAgdmlldyA9IG5vcm1hbGl6ZShjYW1lcmFQb3NpdGlvbiAtIHdvcmxkUG9zaXRpb24pOw0KICBuRG90ViA9IHNhdHVyYXRlKGRvdChub3JtYWwsIHZpZXcpKTsNCn0NCg0Kdm9pZCBzZXRMaWdodFBhcmFtcyh2ZWMzIGxpZ2h0UG9zaXRpb24sDQogICAgdmVjMyB3b3JsZFBvc2l0aW9uLA0KICAgIHZlYzMgViwNCiAgICB2ZWMzIE4sDQogICAgaW5vdXQgdmVjMyBMLA0KICAgIGlub3V0IHZlYzMgSCwNCiAgICBpbm91dCBmbG9hdCBuRG90TCwNCiAgICBpbm91dCBmbG9hdCBuRG90SCwNCiAgICBpbm91dCBmbG9hdCB2RG90SCwNCiAgICBpbm91dCBmbG9hdCBsRG90SCkgew0KICBMID0gbm9ybWFsaXplKGxpZ2h0UG9zaXRpb24gLSB3b3JsZFBvc2l0aW9uKTsNCiAgSCA9IG5vcm1hbGl6ZShMICsgVik7DQoNCiAgbkRvdEwgPSBzYXR1cmF0ZShkb3QoTiwgTCkpOw0KICBuRG90SCA9IHNhdHVyYXRlKGRvdChOLCBIKSk7DQogIHZEb3RIID0gc2F0dXJhdGUoZG90KFYsIEgpKTsNCiAgbERvdEggPSBzYXR1cmF0ZShkb3QoTCwgSCkpOw0KfQ0KDQp2b2lkIG1haW4oKSB7DQogIHZlYzMgbWF0ZXJpYWxDb2xvciA9IHVfY29sb3I7DQoNCiAgdmVjNCBvdXRDb2xvck11bHQ7DQogIHZlYzMgbm9ybWFsaXNlZE5vcm1hbCA9IHZfbm9ybWFsOw0KICB2ZWMzIG5vcm1hbGlzZWRWaWV3Ow0KICBmbG9hdCBuRG90VjsNCg0KICBnZW5lcmF0ZVBhcGVyY3JhZnRDb2xvck5vcm1hbCh2X25vcm1hbCwgdl90YW5nZW50LCB2X2Jpbm9ybWFsLCB2X3Bvc2l0aW9uLCBvdXRDb2xvck11bHQsIG5vcm1hbGlzZWROb3JtYWwpOw0KICBzZXRQYXJhbXModl9wb3NpdGlvbiwgbm9ybWFsaXNlZE5vcm1hbCwgbm9ybWFsaXNlZFZpZXcsIG5Eb3RWKTsNCg0KICB2ZWMzIG5vcm1hbGlzZWRMaWdodDsNCiAgdmVjMyBub3JtYWxpc2VkSGFsZjsNCg0KICBmbG9hdCBuRG90TDsNCiAgZmxvYXQgbkRvdEg7DQogIGZsb2F0IHZEb3RIOw0KICBmbG9hdCBsRG90SDsNCg0KICBzZXRMaWdodFBhcmFtcyh1X2xpZ2h0MFBvcywgdl9wb3NpdGlvbiwgbm9ybWFsaXNlZFZpZXcsIG5vcm1hbGlzZWROb3JtYWwsDQogICAgICBub3JtYWxpc2VkTGlnaHQsIG5vcm1hbGlzZWRIYWxmLCBuRG90TCwgbkRvdEgsIHZEb3RILCBsRG90SCk7DQoNCiAgdmVjMyBkaWZmdXNlID0gdmVjMygwLjAsIDAuMCwgMC4wKTsNCiAgdmVjMyBzcGVjdWxhciA9IHZlYzMoMC4wLCAwLjAsIDAuMCk7DQogIHZlYzMgZGVidWcgPSB2ZWMzKDAuMCwgMC4wLCAwLjApOw0KDQogIGV2YWx1YXRlUEJSTGlnaHQobWF0ZXJpYWxDb2xvciAqIG91dENvbG9yTXVsdC5yZ2IsIHVfbGlnaHQwQ29sb3IsIG5Eb3RMLCBuRG90ViwgbkRvdEgsIHZEb3RILCBsRG90SCwgZGlmZnVzZSwgc3BlY3VsYXIsIGRlYnVnLCAxLjApOw0KICB2ZWMzIGFtYmllbnQgPSAoMS4wIC0gdV9tZXRhbGxpYykgKiBtYXRlcmlhbENvbG9yICogb3V0Q29sb3JNdWx0LnJnYiAqIDAuMDsNCg0KICBzZXRMaWdodFBhcmFtcyh1X2xpZ2h0MVBvcywgdl9wb3NpdGlvbiwgbm9ybWFsaXNlZFZpZXcsIG5vcm1hbGlzZWROb3JtYWwsDQogICAgICBub3JtYWxpc2VkTGlnaHQsIG5vcm1hbGlzZWRIYWxmLCBuRG90TCwgbkRvdEgsIHZEb3RILCBsRG90SCk7DQogIGV2YWx1YXRlUEJSTGlnaHQobWF0ZXJpYWxDb2xvciAqIG91dENvbG9yTXVsdC5yZ2IsIHVfbGlnaHQxQ29sb3IsIG5Eb3RMLCBuRG90ViwgbkRvdEgsIHZEb3RILCBsRG90SCwgZGlmZnVzZSwgc3BlY3VsYXIsIGRlYnVnLCAxLjApOw0KDQogIHZlYzMgUiA9IC1yZWZsZWN0KG5vcm1hbGlzZWRWaWV3LCBub3JtYWxpc2VkTm9ybWFsKTsNCiAgc2V0TGlnaHRQYXJhbXModl9wb3NpdGlvbiArIFIsIHZfcG9zaXRpb24sIG5vcm1hbGlzZWRWaWV3LCBub3JtYWxpc2VkTm9ybWFsLA0KICAgICAgbm9ybWFsaXNlZExpZ2h0LCBub3JtYWxpc2VkSGFsZiwgbkRvdEwsIG5Eb3RILCB2RG90SCwgbERvdEgpOw0KICAgICAgICB2ZWMzIGVudkNvbG9yID0gbWl4KG1hdGVyaWFsQ29sb3IsIHZlYzMoMS4wLCAxLjAsIDEuMCksIDAuNyk7DQogIGV2YWx1YXRlUEJSTGlnaHQobWF0ZXJpYWxDb2xvciAqIG91dENvbG9yTXVsdC5yZ2IsIGVudkNvbG9yICogZW52aXJvbm1lbnRTdHJlbmd0aCwgbkRvdEwsIG5Eb3RWLCBuRG90SCwgdkRvdEgsIGxEb3RILCBkaWZmdXNlLCBzcGVjdWxhciwgZGVidWcsIDAuMjUpOw0KICBnbF9GcmFnQ29sb3IgPSB2ZWM0KHNwZWN1bGFyICsgZGlmZnVzZSAqIG1hdGVyaWFsQ29sb3IsIDEuMCk7DQp9DQo=";

	var vsBase64 = "data:text/plain;base64,dW5pZm9ybSBtYXQ0IHVfbW9kZWxWaWV3TWF0cml4Ow0KdW5pZm9ybSBtYXQ0IHVfcHJvamVjdGlvbk1hdHJpeDsNCnVuaWZvcm0gbWF0MyB1X25vcm1hbE1hdHJpeDsNCg0KYXR0cmlidXRlIHZlYzMgYV9wb3NpdGlvbjsNCmF0dHJpYnV0ZSB2ZWMzIGFfbm9ybWFsOw0KDQp2YXJ5aW5nIHZlYzMgdl9ub3JtYWw7DQp2YXJ5aW5nIHZlYzMgdl9wb3NpdGlvbjsNCnZhcnlpbmcgdmVjMyB2X2Jpbm9ybWFsOw0KdmFyeWluZyB2ZWMzIHZfdGFuZ2VudDsNCg0Kdm9pZCBtYWluKCkgew0KICB2ZWMzIG9ialBvc2l0aW9uID0gYV9wb3NpdGlvbjsNCiAgdmVjNCB3b3JsZFBvc2l0aW9uID0gdmVjNChvYmpQb3NpdGlvbiwgMS4wKTsNCg0KICAvLyBPdXIgb2JqZWN0IHNwYWNlIGhhcyBubyByb3RhdGlvbiBhbmQgbm8gc2NhbGUsIHNvIHRoaXMgaXMgZmluZS4NCiAgdl9ub3JtYWwgPSBhX25vcm1hbDsNCiAgdl9wb3NpdGlvbiA9IHdvcmxkUG9zaXRpb24ueHl6Ow0KICAvLyBMb29raW5nIGZvciBhbiBhcmJpdHJhcnkgdmVjdG9yIHRoYXQgaXNuJ3QgcGFyYWxsZWwgdG8gdGhlIG5vcm1hbC4gIEF2b2lkaW5nIGF4aXMgZGlyZWN0aW9ucyBzaG91bGQgaW1wcm92ZSBvdXIgY2hhbmNlcy4NCiAgdmVjMyBhcmJpdHJhcnlWZWN0b3IgPSBub3JtYWxpemUodmVjMygwLjQyLCAtMC4yMSwgMC4xNSkpOw0KICB2ZWMzIGFsdGVybmF0ZUFyYml0cmFyeVZlY3RvciA9IG5vcm1hbGl6ZSh2ZWMzKDAuNDMsIDEuNSwgMC4xNSkpOw0KICAvLyBJZiBhcmJpdHJhcnkgdmVjdG9yIGlzIHBhcmFsbGVsIHRvIHRoZSBub3JtYWwsIGNob29zZSBhIGRpZmZlcmVudCBvbmUuDQogIHZfdGFuZ2VudCA9IG5vcm1hbGl6ZShhYnMoZG90KHZfbm9ybWFsLCBhcmJpdHJhcnlWZWN0b3IpKSA8IDEuMCA/IGNyb3NzKHZfbm9ybWFsLCBhcmJpdHJhcnlWZWN0b3IpIDogY3Jvc3Modl9ub3JtYWwsIGFsdGVybmF0ZUFyYml0cmFyeVZlY3RvcikpOw0KICB2X2Jpbm9ybWFsID0gbm9ybWFsaXplKGNyb3NzKHZfbm9ybWFsLCB2X3RhbmdlbnQpKTsNCg0KICBnbF9Qb3NpdGlvbiA9IHVfcHJvamVjdGlvbk1hdHJpeCAqIHVfbW9kZWxWaWV3TWF0cml4ICogdmVjNChvYmpQb3NpdGlvbiwgMS4wKTsNCn0NCg==";

	function GBlockLoader () {

	  THREE.GLTFLoader.call(this);

	  var self = this;

	  this._parse = this.parse;
	  this.parse = function (data, path, onLoad, onError) {
	    // convert uint8 to json
	    var json = JSON.parse(convertUint8ArrayToString(data));
	    // use base64 shaders
	    Object.keys(json.shaders).forEach(function (key, i) {
	      if (key.indexOf('fragment') > -1) json.shaders[key].uri = fsBase64;
	      else if (key.indexOf('vertex') > -1) json.shaders[key].uri = vsBase64;
	    });
	    // convert json to uint8
	    var uint8array = new TextEncoder('utf-8').encode(JSON.stringify(json));
	    // parse data
	    self._parse.call(self, uint8array, path, onLoad, onError);
	  };

	}
	GBlockLoader.prototype = THREE.GLTFLoader.prototype;

	// aframe module

	// check if gblock component has already been registered
	if (AFRAME.components.gblock) {
	  if (window.io3d) {
	    throw 'Error: gBlock component is already included in the 3dio.js library. Please remove this "<script>" tag.'
	  } else {
	    throw 'Error: gBlock component has been already registered in another script. Please remove this "<script>" tag.'
	  }
	}

	AFRAME.registerComponent('gblock', {
	  schema: {type: 'asset'},

	  init: function () {
	    this.model = null;
	    this.loader = new GBlockLoader();
	  },

	  update: function () {
	    var self = this;
	    var el = this.el;
	    var src = this.data;

	    if (!src) { return; }

	    this.remove();

	    // FIXME: Replace this with an official API URL once available
	    // This API call is only needed to obtain the official glTF URL of a google block model.
	    // The glTF itself is not being proxied and gets fetched from https://vr.google.com/downloads/* directly.
	    // https://github.com/archilogic-com/aframe-gblock/issues/1
	    // API server code: server/index.js
	    fetch('https://us-central1-gblock-api.cloudfunctions.net/get-gltf-url/?url=' + src).then(function (response) {

	      return response.json().then(function (message) {
	        if (!response.ok) throw new Error('ERROR: ' + response.status + ' "' + message.message + '"')

	        // load glTF model from original URL
	        var gltfUrl = message.gltfUrl;

	        self.loader.load( gltfUrl, function gltfLoaded (gltfModel) {
	          self.model = gltfModel.scene || gltfModel.scenes[0];
	          // FIXME: adapt projection matrix in original shaders
	          self.model.traverse(function (child) {
	            if (child.material) child.material = new THREE.MeshPhongMaterial({ vertexColors: THREE.VertexColors });
	          });
	          self.model.animations = gltfModel.animations;
	          el.setObject3D('mesh', self.model);
	          el.emit('model-loaded', {format: 'gltf', model: self.model});
	        });

	      })
	    });

	  },

	  remove: function () {
	    if (!this.model) { return; }
	    this.el.removeObject3D('mesh');
	  }
	});

	// helpers

	// from https://github.com/mrdoob/three.js/blob/master/examples/js/loaders/GLTFLoader.js
	function convertUint8ArrayToString (array) {
	  if (window.TextDecoder !== undefined) {
	    return new TextDecoder().decode(array);
	  }
	  // Avoid the String.fromCharCode.apply(null, array) shortcut, which
	  // throws a "maximum call stack size exceeded" error for large arrays.
	  var s = '';
	  for (var i = 0, il = array.length; i < il; i++) {
	    s += String.fromCharCode(array[i]);
	  }
	  return s;
	}

}());
//# sourceMappingURL=gblock.js.map
